# ===================================================================
# Enterprise CI/CD Pipeline - Multi-Layer
# ===================================================================
# Structure:
# â”œâ”€â”€ ðŸŸ¢ Backend (lint, test, security)
# â”œâ”€â”€ ðŸ”µ Audit (code quality checks)
# â”œâ”€â”€ ðŸŸ£ Frontend (build)
# â””â”€â”€ ðŸŸ¡ Deploy (optional)
# ===================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: "20"

# ===================================================================
# JOB GROUPS
# ===================================================================

jobs:
  # ===================================================================
  # ðŸŸ¢ BACKEND - Core backend testing and security
  # ===================================================================
  
  backend-lint:
    name: ðŸŸ¢ Backend Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true
        continue-on-error: true

  backend-test:
    name: ðŸŸ¢ Backend Test
    runs-on: ubuntu-latest
    needs: backend-lint
    
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  backend-security:
    name: ðŸŸ¢ Backend Security
    runs-on: ubuntu-latest
    needs: backend-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Audit dependencies
        run: npm audit --audit-level=high
        continue-on-error: true

  # ===================================================================
  # ðŸ”µ AUDIT - Code quality and best practices
  # ===================================================================
  
  audit-code-quality:
    name: ðŸ”µ Audit Code Quality
    runs-on: ubuntu-latest
    needs: backend-security

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check || true
        continue-on-error: true

      - name: Check for dangerous patterns
        run: |
          echo "Checking for hardcoded secrets..."
          grep -r "password\s*=\s*['\"]" api/ --include="*.js" || echo "No hardcoded passwords found"
          grep -r "secret\s*=\s*['\"]" api/ --include="*.js" || echo "No hardcoded secrets found"

  audit-coverage:
    name: ðŸ”µ Audit Coverage
    runs-on: ubuntu-latest
    needs: audit-code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: |
          npm test -- --coverage || true
        continue-on-error: true

  audit-dependencies:
    name: ðŸ”µ Audit Dependencies
    runs-on: ubuntu-latest
    needs: audit-coverage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check outdated packages
        run: npm outdated --depth=0 || true

      - name: Verify package integrity
        run: npm ping || true

  # ===================================================================
  # ðŸŸ£ FRONTEND - Client build and test
  # ===================================================================
  
  frontend-install:
    name: ðŸŸ£ Frontend Install
    runs-on: ubuntu-latest
    needs: audit-dependencies

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

  frontend-lint:
    name: ðŸŸ£ Frontend Lint
    runs-on: ubuntu-latest
    needs: frontend-install

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Run client linter
        working-directory: ./client
        run: npm run lint || true
        continue-on-error: true

  frontend-build:
    name: ðŸŸ£ Frontend Build
    runs-on: ubuntu-latest
    needs: frontend-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Build client
        working-directory: ./client
        run: npm run build

  # ===================================================================
  # ðŸŸ¡ VERIFICATION - Final checks
  # ===================================================================
  
  verify-all:
    name: âœ… All Systems Go
    runs-on: ubuntu-latest
    needs: [backend-test, backend-security, audit-dependencies, frontend-build]

    steps:
      - name: Create status summary
        run: |
          echo "============================================"
          echo "âœ… CI/CD Pipeline Complete!"
          echo "============================================"
          echo "âœ“ Backend Tests Passed"
          echo "âœ“ Security Audit Complete"
          echo "âœ“ Code Quality Checked"
          echo "âœ“ Frontend Built Successfully"
          echo "============================================"
